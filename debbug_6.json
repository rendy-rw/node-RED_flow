[
    {
        "id": "4b0d46176830263d",
        "type": "tab",
        "label": "MESUR 3 SYSTEM",
        "disabled": false,
        "info": "Sistem Monitoring Seismik IoT Final v2.0\n- Fixed Syntax Errors\n- Multi-Node Support\n- Master-Detail View"
    },
    {
        "id": "c10bd4eb1ea73e9b",
        "type": "inject",
        "z": "4b0d46176830263d",
        "name": "Init on Boot",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "0.1",
        "topic": "",
        "payload": "{}",
        "payloadType": "json",
        "x": 130,
        "y": 80,
        "wires": [
            [
                "77021b38fae22db8"
            ]
        ]
    },
    {
        "id": "77021b38fae22db8",
        "type": "change",
        "z": "4b0d46176830263d",
        "name": "Reset Globals",
        "rules": [
            {
                "t": "set",
                "p": "seiscatch_status",
                "pt": "global",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "global_command",
                "pt": "global",
                "to": "STOP",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "plot_mode",
                "pt": "flow",
                "to": "TIME",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 320,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "b8e5fdd96ce1dfa1",
        "type": "mqtt in",
        "z": "4b0d46176830263d",
        "name": "Uplink (Wildcard)",
        "topic": "seismic/uplink/#",
        "qos": "0",
        "datatype": "auto",
        "broker": "brk_mosquitto",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 100,
        "y": 200,
        "wires": [
            [
                "fd2c530723fb3ace",
                "a50e6f81e2dde30a"
            ]
        ]
    },
    {
        "id": "fd2c530723fb3ace",
        "type": "function",
        "z": "4b0d46176830263d",
        "name": "Logic Core (Router)",
        "func": "// LOGIC CORE FINAL FIX (Hybrid Input Support)\nvar payload = msg.payload;\nvar topicParts = msg.topic.split('/');\nvar nodeID = topicParts[topicParts.length - 1]; \nif (!nodeID || nodeID === \"uplink\") nodeID = \"001\";\n\n// 1. NORMALISASI INPUT KE STRING\n// Kita ubah dulu payload jadi string biasa untuk dicek\nvar strInput = (Buffer.isBuffer(payload)) ? payload.toString('utf8') : payload.toString();\nstrInput = strInput.trim();\n\n// 2. HEADER STRIPPING (Buang Timestamp Dragino jika ada)\n// Format: \"2025-XX-XX..., -90, DATA\"\n// Kita ambil bagian setelah koma terakhir\nvar lastComma = strInput.lastIndexOf(',');\nvar cleanStr = (lastComma !== -1) ? strInput.substring(lastComma + 1).trim() : strInput;\n\n// 3. INIT GLOBAL STATUS\nvar statusMap = global.get('seiscatch_status') || {};\nif (!statusMap[nodeID]) {\n    statusMap[nodeID] = { vcc: 0, status: \"Online\", time: Date.now(), id: nodeID };\n}\n\n// =================================================\n// JALUR A: DATA STATUS (TEKS)\n// Cek langsung pada string, TANPA decode hex\n// =================================================\nif (cleanStr.includes(\"stat=\") || cleanStr.includes(\"sys=\")) {\n    \n    // A.4 START SESSION (Menangkap T0)\n    // Format: stat=SESSION&t0=1764530000\n    if (cleanStr.includes(\"stat=SESSION\")) {\n        var t0Match = cleanStr.match(/t0=(\\d+)/);\n        if (t0Match) {\n            var t0_val = parseInt(t0Match[1]);\n            global.set('session_t0_' + nodeID, t0_val * 1000); \n            statusMap[nodeID].status = \"Session Started (\" + t0_val + \")\";\n            node.warn(\"Session Start Node \" + nodeID);\n        }\n    }\n\n    // A.1 Update VCC\n    if (cleanStr.includes(\"sys=\")) {\n        var match = cleanStr.match(/sys=(\\d+)/);\n        if (match) statusMap[nodeID].vcc = parseInt(match[1]);\n        statusMap[nodeID].status = \"Idle / Polling\";\n    }\n    statusMap[nodeID].time = Date.now();\n\n    // A.2 Handshake Waktu\n    if (cleanStr.includes(\"stat=TIME_REQ\")) {\n        var now = Math.floor(Date.now() / 1000);\n        setTimeout(function() {\n            node.send([null, null, { payload: \"TIME:\" + now, topic: \"seismic/downlink\" }]);\n        }, 1200); \n        statusMap[nodeID].status = \"Syncing Time\";\n    }\n\n    // A.3 Cek Tugas (POLL)\n    if (cleanStr.includes(\"stat=POLL\")) {\n        var cmd = global.get('global_command') || \"STOP\";\n        if (cmd === \"REQ_ACQ\") {\n            setTimeout(function() {\n                node.send([null, null, { payload: \"ACQ_START\", topic: \"seismic/downlink\" }]);\n            }, 1200);\n            statusMap[nodeID].status = \"Starting Acquisition\";\n        }\n    }\n\n    global.set('seiscatch_status', statusMap);\n    node.send([{ payload: statusMap }, null, null]);\n    \n    return null; // Selesai, stop disini.\n}\n\n// =================================================\n// JALUR B: DATA SEISMIK (HEX STRING)\n// =================================================\n// Jika panjang string > 20 dan BUKAN status, baru kita coba decode Hex\nelse if (strInput.length > 20) {\n    \n    statusMap[nodeID].status = \"Receiving Data\";\n    statusMap[nodeID].time = Date.now();\n    global.set('seiscatch_status', statusMap);\n    node.send([{ payload: statusMap }, null, null]);\n\n    try {\n        // Ambil data hex (setelah koma terakhir header Dragino)\n        // cleanStr di sini berisi Hex String murni (\"003000...\")\n        var dataBuffer = Buffer.from(cleanStr, 'hex');\n        \n        if (dataBuffer.length > 0) {\n            var msgBiner = { payload: dataBuffer, topic: nodeID };\n            node.send([null, msgBiner, null]);\n        }\n    } catch(e) {\n        return null; // Bukan hex valid\n    }\n}\n\nreturn null;",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 200,
        "wires": [
            [
                "c4de66d3ebfc9eb6"
            ],
            [
                "a39ab7b5478f4e4c"
            ],
            [
                "5689ac759f6f5649"
            ]
        ]
    },
    {
        "id": "a39ab7b5478f4e4c",
        "type": "function",
        "z": "4b0d46176830263d",
        "name": "Binary Parser (Int16)",
        "func": "// BINARY PARSER (SMART ADAPTIVE)\n// Kompatibel dengan SF7 Atomic Payload (Header <1> + Seq + Data)\n\nvar buf = msg.payload;\nvar nodeID = msg.topic;\n\n// 1. Validasi Dasar\nif (!Buffer.isBuffer(buf) || buf.length < 5) return null;\n\nvar seqNum = 0;\nvar seismicData = null;\n\n// 2. Deteksi Header <1> (ASCII: 0x3C, 0x31, 0x3E)\n// Cek apakah byte pertama adalah '<' (0x3C)\nif (buf[0] === 0x3C) {\n    // Header Terdeteksi: [<, 1, >, Seq, Data...]\n    // Sequence ada di Byte ke-3\n    seqNum = buf[3];\n    // Data mulai dari Byte ke-4\n    seismicData = buf.slice(4);\n} else {\n    // Header Tidak Ada (Sudah dibuang Dragino): [Seq, Data...]\n    // Sequence ada di Byte ke-0\n    seqNum = buf[0];\n    // Data mulai dari Byte ke-1\n    seismicData = buf.slice(1);\n}\n\nvar points = [];\n\n// 3. Decoding Int16 Little Endian (Loop Adaptif)\n// Loop ini otomatis menyesuaikan dengan panjang data (30 byte atau 100 byte)\nfor (var i = 0; i < seismicData.length; i += 2) {\n    // Pastikan pasangan byte lengkap\n    if (i + 1 < seismicData.length) {\n        var val = seismicData.readInt16LE(i);\n        points.push(val);\n    }\n}\n\n// 4. Output\nmsg.payload = points;\nmsg.topic = nodeID;\nmsg.packet_seq = seqNum;\n\n// Info debug panjang data (untuk cek throughput)\nmsg.data_len = seismicData.length; \n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 660,
        "y": 260,
        "wires": [
            [
                "17f57f866a6f092d",
                "node_prog_logic"
            ]
        ]
    },
    {
        "id": "b342767ebf8db84f",
        "type": "function",
        "z": "4b0d46176830263d",
        "name": "Set Selected Node & Redirect",
        "func": "// FILTER PENGAMAN:\n// Hanya proses jika payload adalah STRING (ID Node, misal \"001\")\n// Abaikan jika payload adalah Object (Data update status)\nif (typeof msg.payload !== 'string') {\n    return null;\n}\n\n// 1. Set Global Variable\nglobal.set('selected_view_node', msg.payload);\n\n// 2. Notifikasi UI\nvar notifMsg = {payload: \"Memuat data Node: \" + msg.payload};\n\n// 3. Redirect ke Tab Analisis\nvar navMsg = {payload: {tab: \"PLOT & ANALISIS\"}};\n\nreturn [notifMsg, navMsg];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 140,
        "wires": [
            [
                "e1e3a55fc83d061e",
                "21697e6f0594d951"
            ],
            [
                "bdc77e620892f515"
            ]
        ]
    },
    {
        "id": "e1e3a55fc83d061e",
        "type": "ui_toast",
        "z": "4b0d46176830263d",
        "position": "bottom_right",
        "displayTime": "2000",
        "highlight": "",
        "sendall": true,
        "outputs": 0,
        "ok": "OK",
        "cancel": "",
        "raw": false,
        "className": "",
        "topic": "",
        "name": "Notif",
        "x": 1110,
        "y": 40,
        "wires": []
    },
    {
        "id": "bdc77e620892f515",
        "type": "ui_ui_control",
        "z": "4b0d46176830263d",
        "name": "Redirect Plot Tab",
        "events": "all",
        "x": 1450,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "5689ac759f6f5649",
        "type": "mqtt out",
        "z": "4b0d46176830263d",
        "name": "Ke Dragino",
        "topic": "",
        "qos": "0",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "brk_mosquitto",
        "x": 630,
        "y": 340,
        "wires": []
    },
    {
        "id": "4763faf0c8a849c7",
        "type": "catch",
        "z": "4b0d46176830263d",
        "name": "On Deploy",
        "scope": null,
        "uncaught": false,
        "x": 500,
        "y": 80,
        "wires": [
            [
                "416a3f916355ab56"
            ]
        ]
    },
    {
        "id": "416a3f916355ab56",
        "type": "change",
        "z": "4b0d46176830263d",
        "name": "Fetch Map",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "seiscatch_status",
                "tot": "global"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 910,
        "y": 80,
        "wires": [
            [
                "c4de66d3ebfc9eb6"
            ]
        ]
    },
    {
        "id": "3511fd9751309dee",
        "type": "ui_button",
        "z": "4b0d46176830263d",
        "name": "Export CSV",
        "group": "grp_visual",
        "order": 6,
        "width": 7,
        "height": 1,
        "passthru": false,
        "label": "UNDUH DATA (CSV)",
        "tooltip": "",
        "color": "#3E4E50",
        "bgcolor": "#ECEFF1",
        "className": "",
        "icon": "fa-download",
        "payload": "",
        "payloadType": "str",
        "topic": "export",
        "topicType": "str",
        "x": 330,
        "y": 800,
        "wires": [
            [
                "9dfa24d2ac1e33fd"
            ]
        ]
    },
    {
        "id": "9dfa24d2ac1e33fd",
        "type": "function",
        "z": "4b0d46176830263d",
        "name": "Build Query",
        "func": "// BUILD QUERY: SESSION AWARE (FIXED)\n\n// 1. Ambil Node ID yang dipilih\nvar selectedNode = global.get('selected_view_node');\n\nif (!selectedNode) {\n    node.warn(\"⚠️ Tidak ada node yang dipilih untuk didownload.\");\n    return null;\n}\n\n// 2. Ambil Waktu Mulai Sesi Terakhir (T0) dari Global Variable\n// Variabel ini dibuat oleh Logic Core saat menerima \"stat=SESSION\"\nvar sessionStartMs = global.get('session_t0_' + selectedNode);\n\nvar query = \"\";\n\n// 3. Logika Pemilihan Data\nif (sessionStartMs) {\n    // SKENARIO UTAMA: Ada data sesi aktif\n    // Ambil data di mana waktu >= Waktu Mulai Sesi\n    // Kita urutkan ASC (Lama ke Baru) agar CSV rapi dari detik 0 ke detik 5.\n\n    // Note: InfluxQL butuh suffix 'ms' jika kita pakai epoch milliseconds\n    query = `SELECT amplitude FROM seismic_raw WHERE \"node_id\" = '${selectedNode}' AND time >= ${sessionStartMs}ms ORDER BY time ASC`;\n\n    node.warn(\"Downloading Session starting at: \" + new Date(sessionStartMs).toLocaleString());\n}\nelse {\n    // SKENARIO CADANGAN: Jika T0 tidak ada (misal baru restart Node-RED)\n    // Ambil 1000 data terakhir saja sebagai fallback\n\n    query = `SELECT amplitude FROM seismic_raw WHERE \"node_id\" = '${selectedNode}' ORDER BY time DESC LIMIT 1000`;\n\n    node.warn(\"⚠️ Warning: T0 tidak ditemukan. Mengambil 1000 data terakhir.\");\n}\n\nmsg.query = query;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 800,
        "wires": [
            [
                "c5ab2b9fed8d8798"
            ]
        ]
    },
    {
        "id": "c5ab2b9fed8d8798",
        "type": "influxdb in",
        "z": "4b0d46176830263d",
        "influxdb": "conf_influx",
        "name": "Read DB",
        "query": "",
        "rawOutput": false,
        "precision": "",
        "retentionPolicy": "",
        "org": "organisation",
        "x": 650,
        "y": 800,
        "wires": [
            [
                "8514800b210b19b7"
            ]
        ]
    },
    {
        "id": "8514800b210b19b7",
        "type": "function",
        "z": "4b0d46176830263d",
        "name": "To CSV",
        "func": "// TO CSV (Fixed Node ID Logic)\n\nvar data = msg.payload;\n// 1. Ambil ID Node langsung dari Pilihan User (Pasti Benar)\nvar currentNode = global.get('selected_view_node') || \"unknown\";\n\n// Validasi Data\nif (!Array.isArray(data) || data.length === 0) {\n    return null; // Jangan lanjutkan jika kosong\n}\n\n// Header CSV\nvar csv = \"timestamp,node_id,amplitude\\n\";\n\n// Loop Data\nfor (var i = 0; i < data.length; i++) {\n    var row = data[i];\n\n    // Kita gunakan 'currentNode' yang kita ambil dari Global\n    // row.amplitude adalah nilai getaran dari database\n    csv += `${row.time},${currentNode},${row.amplitude}\\n`;\n}\n\nmsg.payload = csv;\n\n// Nama File: seismic_001_timestamp.csv\nvar timeStr = new Date().toISOString().replace(/[:.]/g, \"-\").slice(0, 19);\nmsg.filename = `seismic_${currentNode}_${timeStr}.csv`;\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 800,
        "wires": [
            [
                "d846576f7372cc10"
            ]
        ]
    },
    {
        "id": "ec71eb28517d2790",
        "type": "ui_button",
        "z": "4b0d46176830263d",
        "name": "Back Home",
        "group": "grp_visual",
        "order": 4,
        "width": 3,
        "height": 1,
        "passthru": false,
        "label": "",
        "tooltip": "Kembali ke Daftar Node",
        "color": "",
        "bgcolor": "#ECEFF1",
        "className": "",
        "icon": "fa-arrow-left",
        "payload": "0",
        "payloadType": "num",
        "topic": "nav",
        "topicType": "str",
        "x": 1250,
        "y": 100,
        "wires": [
            [
                "bdc77e620892f515"
            ]
        ]
    },
    {
        "id": "21697e6f0594d951",
        "type": "ui_text",
        "z": "4b0d46176830263d",
        "group": "grp_visual",
        "order": 5,
        "width": 7,
        "height": 1,
        "name": "",
        "label": "Analisis Node:",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": "",
        "color": "#000000",
        "x": 1300,
        "y": 40,
        "wires": []
    },
    {
        "id": "d846576f7372cc10",
        "type": "ui_template",
        "z": "4b0d46176830263d",
        "group": "grp_visual",
        "name": "Modal",
        "order": 8,
        "width": 7,
        "height": 1,
        "format": "<div id=\"csv-modal\" style=\"display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.6); backdrop-filter: blur(2px);\">\n    <div style=\"background-color:#fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 8px; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.1); font-family: 'Roboto', sans-serif;\">\n        <h3 style=\"color:#3E4E50\">Data Siap!</h3>\n        <p style=\"color:#78909C; font-size:0.9em\">File CSV siap diunduh.</p>\n        <a id=\"csv-link\" href=\"#\" target=\"_blank\" \n           style=\"display:block; width:100%; padding:12px 0; background-color:#3E4E50; color:white; text-decoration:none; border-radius:4px; margin-bottom:10px; transition: background 0.3s;\">\n           <i class=\"fa fa-download\"></i> Download CSV\n        </a>\n        <button onclick=\"document.getElementById('csv-modal').style.display='none'\" \n                style=\"width:100%; padding:10px 0; border:none; background:#ECEFF1; color:#455A64; border-radius:4px; cursor:pointer;\">\n            Tutup\n        </button>\n    </div>\n</div>\n<script>\n    (function(scope) {\n        scope.$watch('msg', function(msg) {\n            if (msg && msg.payload) {\n                var blob = new Blob([msg.payload], { type: 'text/csv;charset=utf-8;' });\n                var url = URL.createObjectURL(blob);\n                var link = document.getElementById('csv-link');\n                link.href = url;\n                link.download = msg.filename;\n                document.getElementById('csv-modal').style.display = 'block';\n            }\n        });\n    })(scope);\n</script>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": false,
        "templateScope": "local",
        "className": "",
        "x": 940,
        "y": 800,
        "wires": [
            []
        ]
    },
    {
        "id": "c4de66d3ebfc9eb6",
        "type": "ui_template",
        "z": "4b0d46176830263d",
        "group": "grp_control",
        "name": "Node List Table",
        "order": 8,
        "width": 22,
        "height": 4,
        "format": "<style>\n    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');\n    body { font-family: 'Roboto', sans-serif; }\n    \n    .seis-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; cursor: pointer; }\n    .seis-table th { text-align: left; padding: 10px 5px; color: #546E7A; font-weight: 700; border-bottom: 2px solid #CFD8DC; text-transform: uppercase; font-size: 0.75rem; }\n    .seis-table td { padding: 12px 5px; border-bottom: 1px solid #ECEFF1; color: #37474F; }\n    .seis-table tr:hover { background-color: #F1F8E9; cursor: pointer; transition: background 0.2s; }\n    .seis-table tr.selected { background-color: #DCEDC8; border-left: 4px solid #558B2F; }\n    .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }\n    .bg-green { background: #558B2F; } \n    .bg-blue { background: #455A64; }  \n    .bg-orange { background: #D84315; } \n    .vcc-text { font-weight: 700; color: #263238; }\n    .click-hint { font-size: 0.7rem; color: #90A4AE; display: block; margin-top: 2px; font-style: italic; }\n</style>\n\n<table class=\"seis-table\">\n    <thead>\n        <tr>\n            <th>NODE ID</th>\n            <th>STATUS</th>\n            <th>Daya</th>\n        </tr>\n    </thead>\n    <tbody>\n        <tr ng-repeat=\"(id, node) in msg.payload\" ng-click=\"send({payload: id})\" ng-class=\"{'selected': node.selected}\">\n            <td>\n                <div style=\"font-weight:bold; font-size: 1rem;\">{{node.id}}</div>\n                <span class=\"click-hint\">Klik untuk Analisis</span>\n            </td>\n            <td><span class=\"badge\" \n                ng-class=\"{'bg-green': node.status.includes('Acquisition'), 'bg-blue': node.status.includes('Receiving'), 'bg-orange': node.status.includes('Poll')}\">\n                {{node.status}}</span>\n            </td>\n            <td><span class=\"vcc-text\">{{node.vcc}} mV</span></td>\n        </tr>\n    </tbody>\n</table>",
        "storeOutMessages": true,
        "fwdInMessages": false,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 660,
        "y": 140,
        "wires": [
            [
                "b342767ebf8db84f"
            ]
        ]
    },
    {
        "id": "90e64a3aa09d5c56",
        "type": "ui_template",
        "z": "4b0d46176830263d",
        "group": "grp_control",
        "name": "Header",
        "order": 4,
        "width": 30,
        "height": 4,
        "format": "<div style=\"text-align:center; background: white; padding: 15px; border-bottom: 4px solid #3E4E50; margin-bottom: 10px;\">\n    <h2 style=\"margin:0; color: #3E4E50; font-weight: 800; font-size: 3.8rem; letter-spacing: 1px;\">MESUR</h2>\n    <p style=\"margin:0; color: #78909C; font-size: 1.8rem; text-transform: uppercase;\">IoT Seismic Monitoring System</p>\n    <div style=\"margin-top: 5px; font-size: 2.2rem; color: #455A64; font-weight: 300;\">\n        <i class=\"fa fa-clock-o\"></i> <span id=\"sys-time\">Loading...</span>\n    </div>\n</div>\n<script>\n    (function(scope) {\n        setInterval(function() {\n            var d = new Date();\n            document.getElementById('sys-time').innerText = d.toLocaleTimeString();\n        }, 1000);\n    })(scope);\n</script>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": false,
        "templateScope": "local",
        "className": "",
        "x": 100,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "743088c5481697a3",
        "type": "ui_ui_control",
        "z": "4b0d46176830263d",
        "name": "Trigger: Refresh Home",
        "events": "change",
        "x": 680,
        "y": 40,
        "wires": [
            [
                "416a3f916355ab56"
            ]
        ]
    },
    {
        "id": "17f57f866a6f092d",
        "type": "function",
        "z": "4b0d46176830263d",
        "name": "Format to DB",
        "func": "// FORMATTER DB (Absolute Time Calculation)\nvar values = msg.payload;\nvar nodeID = msg.topic || \"001\";\nvar seqNum = msg.packet_seq;\n\nif (!Array.isArray(values)) return null;\nif (seqNum === undefined) seqNum = 0; // Safety\n\nvar batch = [];\n\n// Ambil T0 dari Global\nvar t0_epoch_ms = global.get('session_t0_' + nodeID);\n\n// Fallback jika T0 tidak ada (pakai waktu sekarang)\nif (!t0_epoch_ms) t0_epoch_ms = Date.now();\n\n// Parameter Sampling\nvar intervalMs = 10; // 100Hz = 10ms\nvar samplesPerPacket = 30; // Sesuaikan dengan chunk Wemos (60 byte / 2)\n\n// Hitung Waktu Awal Paket Ini\nvar packetStartTimeMs = t0_epoch_ms + (seqNum * samplesPerPacket * intervalMs);\n\nfor (var i = 0; i < values.length; i++) {\n    var absoluteTime = packetStartTimeMs + (i * intervalMs);\n\n    batch.push({\n        measurement: \"seismic_raw\",\n        tags: { node_id: nodeID.toString() },\n        fields: { amplitude: parseInt(values[i]) },\n        timestamp: new Date(absoluteTime) // Object Date\n    });\n}\n\nmsg.payload = batch;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 200,
        "wires": [
            [
                "2e16174020b75511"
            ]
        ]
    },
    {
        "id": "2e16174020b75511",
        "type": "influxdb batch",
        "z": "4b0d46176830263d",
        "influxdb": "conf_influx",
        "precision": "ms",
        "retentionPolicy": "",
        "name": "",
        "database": "database",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "organisation",
        "bucket": "bucket",
        "x": 990,
        "y": 200,
        "wires": []
    },
    {
        "id": "ec6a6ec71c493546",
        "type": "ui_template",
        "z": "4b0d46176830263d",
        "group": "grp_visual",
        "name": "Universal Chart (JS)",
        "order": 10,
        "width": 30,
        "height": 6,
        "format": "<script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\n<div style=\"position: relative; height: 100%; width: 100%; padding: 10px;\">\n    <canvas id=\"seismicChart\"></canvas>\n</div>\n\n<script>\n(function(scope) {\n    var myChart = null;\n    var globalCounter = 0; \n    var MAX_POINTS = 1000; \n\n    // Konfigurasi Default\n    var defaultConfig = {\n        labels: [], data: [], xLabel: \"Urutan Sampel\", color: \"#1f77b4\", legend: \"ADC Reading\"\n    };\n\n    function initChart(config) {\n        var ctx = document.getElementById('seismicChart').getContext('2d');\n        if (myChart) myChart.destroy();\n\n        myChart = new Chart(ctx, {\n            type: 'line',\n            data: {\n                labels: config.labels || [],\n                datasets: [{\n                    label: config.legend,\n                    data: config.data || [],\n                    borderColor: config.color,\n                    borderWidth: 1.5,\n                    pointRadius: 0, fill: false, tension: 0.1\n                }]\n            },\n            options: {\n                responsive: true, maintainAspectRatio: false, animation: false,\n                interaction: { mode: 'index', intersect: false },\n                scales: {\n                    x: { title: { display: true, text: config.xLabel }, ticks: { maxTicksLimit: 10 } },\n                    y: { title: { display: true, text: 'Amplitudo' } }\n                }\n            }\n        });\n    }\n\n    setTimeout(function() { if (!myChart) initChart(defaultConfig); }, 200);\n\n    scope.$watch('msg', function(msg) {\n        if (!msg) return;\n\n        // A. GANTI KONFIGURASI\n        if (msg.topic === \"CONFIG_CHANGE\") {\n            initChart(msg.payload);\n        } \n        \n        // B. REPLACE DATA (History / FFT)\n        else if (myChart && msg.topic === \"REPLACE_DATA\") {\n            myChart.data.labels = msg.payload.labels;\n            myChart.data.datasets[0].data = msg.payload.data;\n            \n            // *** FIX: SINKRONISASI COUNTER DARI BACKEND ***\n            if (msg.payload.isHistory && msg.payload.lastCounter !== undefined) {\n                globalCounter = msg.payload.lastCounter;\n            } else {\n                // Jika FFT atau lainnya, reset counter dummy\n                globalCounter = msg.payload.data.length;\n            }\n            \n            myChart.update();\n        }\n        \n        // C. APPEND DATA (Realtime)\n        else if (myChart && msg.topic === \"APPEND_DATA\") {\n            var newData = msg.payload.data;\n            var newLabels = msg.payload.labels; \n            \n            if (newData && newLabels) {\n                for (var i = 0; i < newData.length; i++) {\n                    // Prioritaskan label dari backend jika ada\n                    // Jika tidak, pakai globalCounter lokal (fallback)\n                    var lbl = (newLabels[i] !== undefined) ? newLabels[i] : globalCounter++;\n                    \n                    myChart.data.labels.push(lbl);\n                    myChart.data.datasets[0].data.push(newData[i]);\n                    \n                    // Sync lokal counter jika label backend lebih besar\n                    if (lbl >= globalCounter) globalCounter = lbl + 1;\n                }\n                \n                var excess = myChart.data.labels.length - MAX_POINTS;\n                if (excess > 0) {\n                    myChart.data.labels.splice(0, excess);\n                    myChart.data.datasets[0].data.splice(0, excess);\n                }\n                myChart.update('none'); \n            }\n        }\n    });\n})(scope);\n</script>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1340,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "101677531990619f",
        "type": "function",
        "z": "4b0d46176830263d",
        "name": "Chart Formatter",
        "func": "// CHART FORMATTER (Time Series Dedicated)\n// Menangani: \n// 1. APPEND_DATA (Realtime dari Dispatcher)\n// 2. REPLACE_DATA (History dari Database)\n\nvar inputData = msg.payload;\nvar outputMsg = {};\nvar labels = [];\nvar values = [];\n\n// Validasi: Data harus Array\nif (!Array.isArray(inputData)) return null;\n\n// --- KASUS A: HISTORY REPLAY (REPLACE) ---\n// Ciri: Topik khusus 'HISTORY_REPLAY' (dari node Format History)\nif (msg.topic === \"HISTORY_REPLAY\") {\n    \n    // Data history formatnya: [{x: time, y: amp}, ...]\n    // Kita perlu pisahkan untuk Chart.js\n    var histData = inputData[0]; // Biasanya dibungkus array luar oleh Format History\n    \n    // Jika formatnya belum terbungkus array luar, pakai langsung\n    if (!Array.isArray(histData)) histData = inputData;\n\n    labels = histData.map(function(d) { return new Date(d.x).toLocaleTimeString(); });\n    values = histData.map(function(d) { return d.y; });\n\n    outputMsg.topic = \"REPLACE_DATA\";\n    outputMsg.payload = { \n        data: values, \n        labels: labels, // Label waktu real untuk history\n        isHistory: true \n    };\n    return outputMsg;\n}\n\n// --- KASUS B: REALTIME STREAMING (APPEND) ---\n// Ciri: Array Angka Murni (Integer) dari Dispatcher\nelse {\n    // Ambil Start Index dari Binary Parser (agar sumbu X jalan terus 100, 101...)\n    var startIndex = msg.start_index; \n    if (startIndex === undefined) startIndex = 0;\n\n    labels = [];\n    values = inputData;\n\n    // Buat label urut (Continuous Counter)\n    for(var i=0; i<inputData.length; i++) {\n        labels.push(startIndex + i);\n    }\n\n    outputMsg.topic = \"APPEND_DATA\";\n    outputMsg.payload = { \n        data: values,\n        labels: labels \n    };\n    return outputMsg;\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1120,
        "y": 620,
        "wires": [
            [
                "ec6a6ec71c493546"
            ]
        ]
    },
    {
        "id": "btn_calc_fft",
        "type": "ui_button",
        "z": "4b0d46176830263d",
        "name": "Hitung FFT",
        "group": "grp_visual",
        "order": 3,
        "width": 4,
        "height": 1,
        "passthru": false,
        "label": "HITUNG FFT (DATA TERAKHIR)",
        "tooltip": "Analisis spektrum dari data database",
        "color": "white",
        "bgcolor": "#D84315",
        "className": "",
        "icon": "fa-bar-chart",
        "payload": "CALC",
        "payloadType": "str",
        "topic": "trigger_fft",
        "topicType": "str",
        "x": 110,
        "y": 700,
        "wires": [
            [
                "func_build_fft_query"
            ]
        ]
    },
    {
        "id": "func_build_fft_query",
        "type": "function",
        "z": "4b0d46176830263d",
        "name": "Build FFT Query",
        "func": "// BUILD QUERY (Session Filter)\nvar selectedNode = global.get('selected_view_node');\nif (!selectedNode) {\n    node.warn(\"Pilih Node dulu\");\n    return null;\n}\n\nvar sessionStartMs = global.get('session_t0_' + selectedNode);\nvar query = \"\";\n\nif (sessionStartMs) {\n    // Ambil data sesi ini saja\n    query = `SELECT amplitude FROM seismic_raw WHERE \"node_id\" = '${selectedNode}' AND time >= ${sessionStartMs}ms ORDER BY time ASC`;\n} else {\n    // Fallback\n    query = `SELECT amplitude FROM seismic_raw WHERE \"node_id\" = '${selectedNode}' ORDER BY time DESC LIMIT 1000`;\n}\n\nmsg.query = query;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 310,
        "y": 700,
        "wires": [
            [
                "influx_read_fft"
            ]
        ]
    },
    {
        "id": "influx_read_fft",
        "type": "influxdb in",
        "z": "4b0d46176830263d",
        "influxdb": "conf_influx",
        "name": "Read DB",
        "query": "",
        "rawOutput": false,
        "precision": "",
        "retentionPolicy": "",
        "org": "organisation",
        "x": 480,
        "y": 700,
        "wires": [
            [
                "func_prep_py_fft"
            ]
        ]
    },
    {
        "id": "func_prep_py_fft",
        "type": "function",
        "z": "4b0d46176830263d",
        "name": "Format Array",
        "func": "var data = msg.payload;\nif (!Array.isArray(data) || data.length === 0) return null;\n\nvar values = [];\n// Ganti jadi loop MAJU (i++)\nfor (var i = 0; i < data.length; i++) {\n    values.push(data[i].amplitude);\n}\n\n// Kirim sebagai JSON String ke Python\nmsg.payload = JSON.stringify(values);\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 650,
        "y": 700,
        "wires": [
            [
                "exec_py_fft"
            ]
        ]
    },
    {
        "id": "exec_py_fft",
        "type": "exec",
        "z": "4b0d46176830263d",
        "command": "python3 /data/seismic_calc.py",
        "addpay": true,
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "oldrc": false,
        "name": "Run Python",
        "x": 850,
        "y": 700,
        "wires": [
            [
                "func_fft_formatter"
            ],
            [],
            []
        ]
    },
    {
        "id": "func_fft_formatter",
        "type": "function",
        "z": "4b0d46176830263d",
        "name": "FFT Formatter (JS)",
        "func": "try {\n    var result = JSON.parse(msg.payload);\n    \n    if (result.status === \"OK\" && result.fft) {\n        var labels = [];\n        var values = [];\n        \n        // Pisahkan X (Freq) dan Y (Amp) untuk Chart.js\n        for(var i=0; i<result.fft.length; i++) {\n            labels.push(result.fft[i].x);\n            values.push(result.fft[i].y);\n        }\n        \n        msg.payload = {\n            labels: labels,\n            data: values\n        };\n        msg.topic = \"UPDATE_FFT\";\n        return msg;\n    }\n} catch(e) { \n    node.warn(\"Error Parse Python: \" + e);\n    return null; \n}\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1070,
        "y": 700,
        "wires": [
            [
                "template_fft_chart"
            ]
        ]
    },
    {
        "id": "template_fft_chart",
        "type": "ui_template",
        "z": "4b0d46176830263d",
        "group": "grp_visual",
        "name": "FFT Chart (JS)",
        "order": 12,
        "width": 30,
        "height": 6,
        "format": "<script src=\"https://cdn.jsdelivr.net/npm/chart.js\"></script>\n\n<div style=\"position: relative; height: 100%; width: 100%; padding: 5px;\">\n    <canvas id=\"fftChart\"></canvas>\n</div>\n\n<script>\n(function(scope) {\n    var fftChart = null;\n\n    function initFFT() {\n        var ctx = document.getElementById('fftChart').getContext('2d');\n        \n        if (fftChart) fftChart.destroy();\n\n        fftChart = new Chart(ctx, {\n            type: 'bar', // Bar chart lebih cocok untuk spektrum diskrit\n            data: {\n                labels: [],\n                datasets: [{\n                    label: 'Spektrum Frekuensi (Post-Process)',\n                    data: [],\n                    backgroundColor: 'rgba(216, 67, 21, 0.6)', // Warna Oranye Transparan\n                    borderColor: '#D84315',\n                    borderWidth: 1,\n                    barPercentage: 1.0,\n                    categoryPercentage: 1.0\n                }]\n            },\n            options: {\n                responsive: true,\n                maintainAspectRatio: false,\n                animation: {\n                    duration: 800 // Animasi halus saat load pertama\n                },\n                scales: {\n                    x: {\n                        title: { display: true, text: 'Frekuensi (Hz)' },\n                        ticks: {\n                            autoSkip: true,\n                            maxTicksLimit: 20\n                        }\n                    },\n                    y: {\n                        title: { display: true, text: 'Magnitudo' },\n                        beginAtZero: true\n                    }\n                }\n            }\n        });\n    }\n\n    // Init awal setelah delay agar DOM siap\n    setTimeout(initFFT, 500);\n\n    scope.$watch('msg', function(msg) {\n        if (!msg || msg.topic !== \"UPDATE_FFT\") return;\n        \n        if (!fftChart) initFFT();\n        \n        // Ganti total data\n        fftChart.data.labels = msg.payload.labels;\n        fftChart.data.datasets[0].data = msg.payload.data;\n        fftChart.update();\n    });\n})(scope);\n</script>",
        "storeOutMessages": false,
        "fwdInMessages": false,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1280,
        "y": 700,
        "wires": [
            []
        ]
    },
    {
        "id": "node_prog_logic",
        "type": "function",
        "z": "4b0d46176830263d",
        "name": "Hitung Progress",
        "func": "// LOGIKA PROGRESS BAR (Kalibrasi 50 Sampel/Paket)\n\n// Total Sampel: 500 (5 detik)\n// Per Paket: 50 Sampel (sesuai debug)\n// Total Paket: 500 / 50 = 10\nvar totalPackets = 10; \n\nvar currentCount = flow.get('pkg_count') || 0;\n\n// 1. Trigger Reset (Dari Tombol Global ACQ)\n// Topik bisa 'trigger_acq' atau 'RESET_PROGRESS' tergantung node sebelumnya\nif (msg.topic === \"trigger_acq\" || msg.topic === \"RESET_PROGRESS\") {\n    flow.set('pkg_count', 0);\n    return { payload: 0, topic: \"Menunggu...\" };\n}\n\n// 2. Hitung Progress (Dari Data Masuk)\n// Pastikan hanya menghitung jika payload adalah array data seismik\nif (Array.isArray(msg.payload) && msg.payload.length > 0) {\n    currentCount++;\n    flow.set('pkg_count', currentCount);\n    \n    // Hitung Persentase\n    var percent = Math.round((currentCount / totalPackets) * 100);\n    \n    // Safety Cap\n    if (percent > 100) percent = 100;\n    \n    msg.payload = percent;\n    msg.topic = \"Menerima: \" + currentCount + \"/\" + totalPackets + \" pkt\";\n    \n    return msg;\n}\n\nreturn null; // Abaikan pesan lain",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 920,
        "y": 260,
        "wires": [
            [
                "node_ui_gauge"
            ]
        ]
    },
    {
        "id": "node_ui_gauge",
        "type": "ui_gauge",
        "z": "4b0d46176830263d",
        "name": "Loading Data",
        "group": "grp_visual",
        "order": 1,
        "width": "8",
        "height": "2",
        "gtype": "gage",
        "title": "Status Penerimaan Data",
        "label": "%",
        "format": "{{value}}%",
        "min": 0,
        "max": 100,
        "colors": [
            "#e74c3c",
            "#f1c40f",
            "#3498db"
        ],
        "seg1": "",
        "seg2": "",
        "diff": false,
        "className": "",
        "x": 1120,
        "y": 260,
        "wires": []
    },
    {
        "id": "node_btn_plot_now",
        "type": "ui_button",
        "z": "4b0d46176830263d",
        "name": "Plot Sekarang",
        "group": "grp_visual",
        "order": 2,
        "width": "4",
        "height": "2",
        "passthru": false,
        "label": "REFRESH PLOT (LAST DATA)",
        "tooltip": "Ambil data dari database dan tampilkan",
        "color": "white",
        "bgcolor": "#1f77b4",
        "className": "",
        "icon": "fa-refresh",
        "payload": "REFRESH",
        "payloadType": "str",
        "topic": "",
        "topicType": "str",
        "x": 420,
        "y": 560,
        "wires": [
            [
                "node_qry_hist"
            ]
        ]
    },
    {
        "id": "node_trig_plot_open",
        "type": "ui_ui_control",
        "z": "4b0d46176830263d",
        "name": "Trigger: On Plot Open",
        "events": "change",
        "x": 140,
        "y": 620,
        "wires": [
            [
                "node_chk_tab"
            ]
        ]
    },
    {
        "id": "node_chk_tab",
        "type": "switch",
        "z": "4b0d46176830263d",
        "name": "Is Plot Tab?",
        "property": "payload.tab",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "PLOT & ANALISIS",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 330,
        "y": 620,
        "wires": [
            [
                "node_qry_hist"
            ]
        ]
    },
    {
        "id": "node_qry_hist",
        "type": "function",
        "z": "4b0d46176830263d",
        "name": "Build History Query",
        "func": "// BUILD QUERY (Session Filter)\nvar selectedNode = global.get('selected_view_node');\nif (!selectedNode) {\n    node.warn(\"Pilih Node dulu\");\n    return null;\n}\n\nvar sessionStartMs = global.get('session_t0_' + selectedNode);\nvar query = \"\";\n\nif (sessionStartMs) {\n    // Ambil data sesi ini saja\n    query = `SELECT amplitude FROM seismic_raw WHERE \"node_id\" = '${selectedNode}' AND time >= ${sessionStartMs}ms ORDER BY time ASC`;\n} else {\n    // Fallback\n    query = `SELECT amplitude FROM seismic_raw WHERE \"node_id\" = '${selectedNode}' ORDER BY time DESC LIMIT 1000`;\n}\n\nmsg.query = query;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 520,
        "y": 620,
        "wires": [
            [
                "node_read_hist"
            ]
        ]
    },
    {
        "id": "node_read_hist",
        "type": "influxdb in",
        "z": "4b0d46176830263d",
        "influxdb": "conf_influx",
        "name": "Fetch History",
        "query": "",
        "rawOutput": false,
        "precision": "",
        "retentionPolicy": "",
        "org": "organisation",
        "x": 730,
        "y": 560,
        "wires": [
            [
                "node_fmt_hist"
            ]
        ]
    },
    {
        "id": "node_fmt_hist",
        "type": "function",
        "z": "4b0d46176830263d",
        "name": "Format History",
        "func": "// FORMAT HISTORY (Fixed & Optimized)\n// Mencegah Crash akibat Loop ganda\n\nvar data = msg.payload;\n\n// 1. Validasi\nif (!Array.isArray(data) || data.length === 0) {\n    return null;\n}\n\n// 2. Transformasi Data (Mapping)\n// Kita gunakan method .map() yang jauh lebih cepat dan aman daripada for-loop manual\n// Karena Query SQL sudah \"ORDER BY time ASC\", urutannya sudah benar.\n\nvar chartData = data.map(function (row) {\n    return {\n        x: new Date(row.time).getTime(), // Konversi ISO String ke Epoch MS\n        y: row.amplitude                 // Nilai Amplitudo\n    };\n});\n\n// 3. Output\n// Bungkus dalam array lagi sesuai standar Chart.js wrapper kita\nmsg.payload = [chartData];\nmsg.topic = \"HISTORY_REPLAY\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 900,
        "y": 620,
        "wires": [
            [
                "101677531990619f"
            ]
        ]
    },
    {
        "id": "de09461d8c185a7c",
        "type": "ui_button",
        "z": "4b0d46176830263d",
        "name": "Btn Reset List",
        "group": "grp_control",
        "order": 5,
        "width": 5,
        "height": 1,
        "passthru": false,
        "label": "RESET DAFTAR",
        "tooltip": "Hapus semua node dari tampilan",
        "color": "black",
        "bgcolor": "",
        "className": "",
        "icon": "fa-trash",
        "payload": "RESET",
        "payloadType": "str",
        "topic": "topic",
        "topicType": "msg",
        "x": 120,
        "y": 140,
        "wires": [
            [
                "de1665b7a937e02e"
            ]
        ]
    },
    {
        "id": "btn_smart_acq",
        "type": "ui_button",
        "z": "4b0d46176830263d",
        "name": "SMART ACQUISITION",
        "group": "grp_control",
        "order": 1,
        "width": 5,
        "height": 2,
        "passthru": false,
        "label": "MULAI SIKLUS PENUH (SEQ)",
        "tooltip": "Rekam serentak, ambil data satu per satu",
        "color": "white",
        "bgcolor": "#D84315",
        "className": "",
        "icon": "fa-play-circle",
        "payload": "START_SEQUENCE",
        "payloadType": "str",
        "topic": "trigger_seq",
        "topicType": "str",
        "x": 160,
        "y": 440,
        "wires": [
            [
                "func_init_broadcast"
            ]
        ]
    },
    {
        "id": "func_init_broadcast",
        "type": "function",
        "z": "4b0d46176830263d",
        "name": "1. Broadcast ACQ",
        "func": "// Langkah 1: Kirim Perintah Rekam ke Semua Node\n\n// Set Global Command agar Wemos yang bangun langsung merekam\nglobal.set('global_command', 'REQ_ACQ');\n\n// Reset Progress Bar (jika ada)\nnode.send({ topic: \"RESET_PROGRESS\", payload: 0 });\n\n// Kirim Perintah Downlink Broadcast\n// Topik tanpa ID spesifik, atau loop ke semua ID nanti\n// Disini kita set global flag saja, nanti Logic Core yang kirim saat POLL\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 440,
        "wires": [
            [
                "delay_recording",
                "node_prog_logic"
            ]
        ]
    },
    {
        "id": "delay_recording",
        "type": "delay",
        "z": "4b0d46176830263d",
        "name": "Tunggu Rekam (20s)",
        "pauseType": "delay",
        "timeout": "20",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 600,
        "y": 480,
        "wires": [
            [
                "func_build_queue"
            ]
        ]
    },
    {
        "id": "func_build_queue",
        "type": "function",
        "z": "4b0d46176830263d",
        "name": "2. Build Queue",
        "func": "// Langkah 2: Buat Daftar Antrean Node\n\n// Ambil semua node yang terdaftar di sistem\nvar statusMap = global.get('seiscatch_status') || {};\nvar nodeList = Object.keys(statusMap);\n\nif (nodeList.length === 0) {\n    node.warn(\"Tidak ada node aktif untuk di-fetch.\");\n    return null;\n}\n\n// Simpan antrean ke flow variable\nflow.set('fetch_queue', nodeList);\nflow.set('is_fetching', true);\n\n// Matikan mode ACQ global agar tidak loop\nglobal.set('global_command', 'STOP');\n\n// Trigger loop pertama\nreturn { payload: \"NEXT\" };",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 440,
        "wires": [
            [
                "func_fetch_looper"
            ]
        ]
    },
    {
        "id": "func_fetch_looper",
        "type": "function",
        "z": "4b0d46176830263d",
        "name": "3. Fetch Sequencer",
        "func": "// Langkah 3: Ambil satu per satu\n\nvar queue = flow.get('fetch_queue') || [];\n\n// Jika antrean habis\nif (queue.length === 0) {\n    flow.set('is_fetching', false);\n    node.warn(\"Siklus Selesai. Semua node telah dipanggil.\");\n    return null;\n}\n\n// Ambil Node ID berikutnya\nvar nextNode = queue.shift();\nflow.set('fetch_queue', queue);\n\n// Kirim Perintah FETCH\n// Topik harus spesifik ke node tersebut agar Dragino mengarahkannya\n// Format: seismic/downlink/NODE_ID (Ini akan dibaca logic core atau langsung ke MQTT Out)\n\nvar mqttMsg = {\n    payload: \"FETCH_DATA\",\n    topic: \"seismic/downlink\"\n};\n\n// Kirim notifikasi UI\nvar uiMsg = { payload: \"Mengambil Data Node: \" + nextNode };\n\n// Update Global Command khusus untuk node ini (agar Logic Core mengirim saat POLL)\n// Atau kita bisa langsung kirim jika Dragino support downlink langsung.\n// Karena Wemos sedang \"Listening\" setelah ACQ, kita kirim langsung via MQTT Out.\n\nreturn [mqttMsg, uiMsg];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1010,
        "y": 440,
        "wires": [
            [
                "delay_fetching",
                "5689ac759f6f5649"
            ],
            [
                "e1e3a55fc83d061e"
            ]
        ]
    },
    {
        "id": "delay_fetching",
        "type": "delay",
        "z": "4b0d46176830263d",
        "name": "Jeda Antar Node (30s)",
        "pauseType": "delay",
        "timeout": "30",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1020,
        "y": 540,
        "wires": [
            [
                "func_fetch_looper"
            ]
        ]
    },
    {
        "id": "a50e6f81e2dde30a",
        "type": "debug",
        "z": "4b0d46176830263d",
        "name": "debug 1",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 250,
        "y": 280,
        "wires": []
    },
    {
        "id": "de1665b7a937e02e",
        "type": "change",
        "z": "4b0d46176830263d",
        "name": "Clear Global Status",
        "rules": [
            {
                "t": "set",
                "p": "seiscatch_status",
                "pt": "global",
                "to": "{}",
                "tot": "json"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 330,
        "y": 140,
        "wires": [
            [
                "416a3f916355ab56"
            ]
        ]
    },
    {
        "id": "5a885f6c9a83903b",
        "type": "ui_spacer",
        "z": "4b0d46176830263d",
        "name": "spacer",
        "group": "grp_visual",
        "order": 7,
        "width": 12,
        "height": 1
    },
    {
        "id": "ca755c36f69e6c8b",
        "type": "ui_spacer",
        "z": "4b0d46176830263d",
        "name": "spacer",
        "group": "grp_visual",
        "order": 9,
        "width": 11,
        "height": 1
    },
    {
        "id": "51d7f46d513083a7",
        "type": "ui_spacer",
        "z": "4b0d46176830263d",
        "name": "spacer",
        "group": "grp_visual",
        "order": 11,
        "width": 30,
        "height": 1
    },
    {
        "id": "eec944d7810fc6bf",
        "type": "ui_spacer",
        "z": "4b0d46176830263d",
        "name": "spacer",
        "group": "grp_control",
        "order": 2,
        "width": 25,
        "height": 1
    },
    {
        "id": "67b537a11765eea9",
        "type": "ui_spacer",
        "z": "4b0d46176830263d",
        "name": "spacer",
        "group": "grp_control",
        "order": 3,
        "width": 25,
        "height": 1
    },
    {
        "id": "91e138a8e35eade5",
        "type": "ui_spacer",
        "z": "4b0d46176830263d",
        "name": "spacer",
        "group": "grp_control",
        "order": 6,
        "width": 25,
        "height": 1
    },
    {
        "id": "668e2cd5da50d908",
        "type": "ui_spacer",
        "z": "4b0d46176830263d",
        "name": "spacer",
        "group": "grp_control",
        "order": 7,
        "width": 4,
        "height": 1
    },
    {
        "id": "12fa70feecab5072",
        "type": "ui_spacer",
        "z": "4b0d46176830263d",
        "name": "spacer",
        "group": "grp_control",
        "order": 9,
        "width": 4,
        "height": 1
    },
    {
        "id": "b130253bac9aa7ee",
        "type": "ui_spacer",
        "z": "4b0d46176830263d",
        "name": "spacer",
        "group": "grp_control",
        "order": 10,
        "width": 4,
        "height": 1
    },
    {
        "id": "dde5b35e9afac858",
        "type": "ui_spacer",
        "z": "4b0d46176830263d",
        "name": "spacer",
        "group": "grp_control",
        "order": 11,
        "width": 4,
        "height": 1
    },
    {
        "id": "d5eceb5f1fe781ad",
        "type": "ui_spacer",
        "z": "4b0d46176830263d",
        "name": "spacer",
        "group": "grp_control",
        "order": 12,
        "width": 4,
        "height": 1
    },
    {
        "id": "e7d91e80d5ea2d02",
        "type": "ui_spacer",
        "z": "4b0d46176830263d",
        "name": "spacer",
        "group": "grp_control",
        "order": 13,
        "width": 4,
        "height": 1
    },
    {
        "id": "0ac5c8fbb2e481c8",
        "type": "ui_spacer",
        "z": "4b0d46176830263d",
        "name": "spacer",
        "group": "grp_control",
        "order": 14,
        "width": 4,
        "height": 1
    },
    {
        "id": "5db793693d7f5b69",
        "type": "ui_spacer",
        "z": "4b0d46176830263d",
        "name": "spacer",
        "group": "grp_control",
        "order": 15,
        "width": 4,
        "height": 1
    },
    {
        "id": "brk_mosquitto",
        "type": "mqtt-broker",
        "name": "Local Broker",
        "broker": "mosquitto",
        "port": "1883",
        "clientid": "",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": "4",
        "keepalive": "60",
        "cleansession": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    },
    {
        "id": "grp_visual",
        "type": "ui_group",
        "name": "VISUALISASI & ANALISIS",
        "tab": "930c653161f1a129",
        "order": 2,
        "disp": true,
        "width": 30,
        "collapse": false,
        "className": ""
    },
    {
        "id": "conf_influx",
        "type": "influxdb",
        "hostname": "influxdb",
        "port": "8086",
        "protocol": "http",
        "database": "seismic_data",
        "name": "Seismic DB",
        "usetls": false,
        "tls": "",
        "influxdbVersion": "1.x",
        "url": "http://localhost:8086",
        "timeout": "",
        "rejectUnauthorized": true
    },
    {
        "id": "grp_control",
        "type": "ui_group",
        "name": "SOH & KONTROL",
        "tab": "tab_dashboard",
        "order": 1,
        "disp": true,
        "width": 30,
        "collapse": false,
        "className": ""
    },
    {
        "id": "930c653161f1a129",
        "type": "ui_tab",
        "name": "PLOT & ANALISIS",
        "icon": "fa-area-chart",
        "order": 2,
        "disabled": false,
        "hidden": false
    },
    {
        "id": "tab_dashboard",
        "type": "ui_tab",
        "name": "Dashboard Utama",
        "icon": "dashboard",
        "order": 1,
        "disabled": false,
        "hidden": false
    },
    {
        "id": "48a70da9c08c357d",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-dashboard": "3.6.6",
            "node-red-contrib-influxdb": "0.7.0"
        }
    }
]